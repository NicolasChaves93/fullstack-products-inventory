<div class="container-material">
  <mat-toolbar color="accent">
    <span>GESTIÓN DE PRODUCTOS Y STOCK</span>
  </mat-toolbar>

  <mat-card class="creation-card">
    <mat-card-header>
      <mat-card-title>Crear Nuevo Producto</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form (ngSubmit)="handleCreateProduct()">
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Nombre del Producto</mat-label>
            <input matInput [(ngModel)]="newProduct.name" name="name" required>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Código (ID)</mat-label>
            <input matInput [(ngModel)]="newProduct.code" name="code" required>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Precio</mat-label>
            <input matInput type="number" [(ngModel)]="newProduct.price" name="price" required min="0">
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripción</mat-label>
            <textarea matInput [(ngModel)]="newProduct.description" name="description" required></textarea>
          </mat-form-field>

          <button mat-raised-button color="primary" type="submit" [disabled]="loading">
            Crear Producto
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <mat-card class="list-card">
    <mat-card-header>
      <mat-card-title>Catálogo (Total: {{ productPage?.totalElements || 0 }})</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="loading" class="loading-spinner">
        Cargando productos...
      </div>

      <div *ngIf="!loading && products.length === 0" class="no-data">
        No se encontraron productos en el catálogo.
      </div>

      <table mat-table [dataSource]="products" *ngIf="products.length > 0 && !loading" class="mat-elevation-z2">
        
        <ng-container matColumnDef="code">
          <th mat-header-cell *matHeaderCellDef>Código</th>
          <td mat-cell *matCellDef="let product"> {{ product.code }} </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Nombre / Descripción</th>
          <td mat-cell *matCellDef="let product">
            <strong>{{ product.name }}</strong>
            <p class="description-text">{{ product.description }}</p>
          </td>
        </ng-container>

        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>Precio</th>
          <td mat-cell *matCellDef="let product"> ${{ product.price | number:'1.2-2' }} </td>
        </ng-container>

        <ng-container matColumnDef="active">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let product">
            <mat-slide-toggle 
              [checked]="product.active"
              (change)="toggleActiveStatus(product)"
              [color]="product.active ? 'primary' : 'warn'">
              {{ product.active ? 'Activo' : 'Inactivo' }}
            </mat-slide-toggle>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let product">
            <button mat-stroked-button color="warn" (click)="handleDelete(product.id)">
              Eliminar
            </button>
          </td>
        </ng-container>

        <ng-container matColumnDef="inventory">
          <th mat-header-cell *matHeaderCellDef>Gestión de Stock</th>
          <td mat-cell *matCellDef="let product">
             <app-inventory-manager [productCode]="product.code"></app-inventory-manager>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <div class="pagination-footer">
          <button mat-button (click)="changePage(-1)" [disabled]="productPage?.first || loading">
              &lt; Anterior
          </button>
          <span class="page-info">
              Página {{ (productPage?.number ?? -1) + 1 }} de {{ productPage?.totalPages ?? 0 }}
          </span>
          <button mat-button (click)="changePage(1)" [disabled]="productPage?.last || loading">
              Siguiente &gt;
          </button>
      </div>
      
    </mat-card-content>
  </mat-card>
</div>